<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CWA Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }
        header {
            background: #16213e;
            padding: 1rem 2rem;
            border-bottom: 1px solid #0f3460;
        }
        header h1 {
            font-size: 1.5rem;
            color: #e94560;
        }
        main {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        .board {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-top: 2rem;
        }
        .column {
            background: #16213e;
            border-radius: 8px;
            padding: 1rem;
            min-height: 400px;
        }
        .column h2 {
            font-size: 0.875rem;
            text-transform: uppercase;
            color: #888;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #0f3460;
        }
        .task {
            background: #0f3460;
            border-radius: 4px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .task:hover {
            transform: translateX(4px);
        }
        .task h3 {
            font-size: 0.875rem;
            font-weight: 500;
        }
        .task .id {
            font-size: 0.75rem;
            color: #666;
            margin-top: 0.25rem;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }
        .stat {
            background: #16213e;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
        }
        .stat h3 {
            font-size: 2rem;
            color: #e94560;
        }
        .stat p {
            font-size: 0.875rem;
            color: #888;
            margin-top: 0.5rem;
        }
        .loading {
            text-align: center;
            padding: 2rem;
            color: #888;
        }
        .error {
            background: #ff000033;
            color: #ff6b6b;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <header>
        <h1>CWA Dashboard</h1>
    </header>
    <main>
        <div id="stats" class="stats">
            <div class="stat">
                <h3 id="backlog-count">-</h3>
                <p>Backlog</p>
            </div>
            <div class="stat">
                <h3 id="todo-count">-</h3>
                <p>Todo</p>
            </div>
            <div class="stat">
                <h3 id="progress-count">-</h3>
                <p>In Progress</p>
            </div>
            <div class="stat">
                <h3 id="done-count">-</h3>
                <p>Done</p>
            </div>
        </div>

        <div id="board" class="board">
            <div class="column">
                <h2>Backlog</h2>
                <div id="col-backlog"></div>
            </div>
            <div class="column">
                <h2>Todo</h2>
                <div id="col-todo"></div>
            </div>
            <div class="column">
                <h2>In Progress</h2>
                <div id="col-in_progress"></div>
            </div>
            <div class="column">
                <h2>Review</h2>
                <div id="col-review"></div>
            </div>
            <div class="column">
                <h2>Done</h2>
                <div id="col-done"></div>
            </div>
        </div>
    </main>

    <script>
        async function loadBoard() {
            try {
                const response = await fetch('/api/board');
                if (!response.ok) throw new Error('Failed to load board');
                const board = await response.json();

                // Clear columns
                document.querySelectorAll('.column > div').forEach(col => col.innerHTML = '');

                // Populate columns and count
                let counts = { backlog: 0, todo: 0, in_progress: 0, review: 0, done: 0 };

                board.columns.forEach(column => {
                    const colEl = document.getElementById('col-' + column.name);
                    if (colEl) {
                        column.tasks.forEach(task => {
                            const taskEl = document.createElement('div');
                            taskEl.className = 'task';
                            taskEl.innerHTML = `
                                <h3>${task.title}</h3>
                                <div class="id">${task.id.substring(0, 8)}</div>
                            `;
                            colEl.appendChild(taskEl);
                        });
                        counts[column.name] = column.tasks.length;
                    }
                });

                // Update stats
                document.getElementById('backlog-count').textContent = counts.backlog;
                document.getElementById('todo-count').textContent = counts.todo;
                document.getElementById('progress-count').textContent = counts.in_progress;
                document.getElementById('done-count').textContent = counts.done;

            } catch (error) {
                console.error('Error loading board:', error);
            }
        }

        // Connect to WebSocket for real-time updates
        function connectWebSocket() {
            const ws = new WebSocket(`ws://${window.location.host}/ws`);

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                if (msg.type === 'BoardRefresh' || msg.type === 'TaskUpdated') {
                    loadBoard();
                }
            };

            ws.onclose = () => {
                // Reconnect after 5 seconds
                setTimeout(connectWebSocket, 5000);
            };
        }

        // Initial load
        loadBoard();
        connectWebSocket();

        // Refresh every 30 seconds
        setInterval(loadBoard, 30000);
    </script>
</body>
</html>
