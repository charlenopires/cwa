{% extends "base.html" %}

{% block title %}{{ board_name }} - CWA Kanban{% endblock %}

{% block content %}
<div class="h-full flex flex-col">
    <div class="flex items-center justify-between px-6 py-3 bg-white border-b">
        <h1 class="text-xl font-semibold text-gray-900">{{ board_name }}</h1>
        <button onclick="document.getElementById('new-card-modal').classList.remove('hidden')"
                class="px-3 py-1.5 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
            + New Card
        </button>
    </div>

    <div class="flex-1 overflow-x-auto p-4">
        <div class="flex gap-4 h-full" id="board-columns">
            {% for column in columns %}
            {% include "partials/column.html" %}
            {% endfor %}
        </div>
    </div>
</div>

<!-- New Card Modal -->
<div id="new-card-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4 p-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold">New Card</h2>
            <button onclick="this.closest('#new-card-modal').classList.add('hidden')"
                    class="text-gray-400 hover:text-gray-600">&times;</button>
        </div>
        <form hx-post="/cards"
              hx-target="#board-columns"
              hx-swap="innerHTML"
              hx-on::after-request="this.reset(); document.getElementById('new-card-modal').classList.add('hidden')">
            <input type="hidden" name="board_id" value="{{ board_id }}">
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" name="title" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea name="description" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                </div>
                <div class="flex gap-3">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Column</label>
                        <select name="column_id"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            {% for column in columns %}
                            <option value="{{ column.id }}">{{ column.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                        <select name="priority"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            <option value="">None</option>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                    <input type="date" name="due_date"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-5">
                <button type="button"
                        onclick="this.closest('#new-card-modal').classList.add('hidden')"
                        class="px-4 py-2 text-sm text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">
                    Cancel
                </button>
                <button type="submit"
                        class="px-4 py-2 text-sm text-white bg-blue-600 rounded-md hover:bg-blue-700">
                    Create
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    initSortable();
});

document.addEventListener('htmx:afterSwap', () => {
    initSortable();
});

function initSortable() {
    document.querySelectorAll('.cards-container').forEach(container => {
        if (container._sortable) container._sortable.destroy();
        container._sortable = new Sortable(container, {
            group: 'cards',
            animation: 150,
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'opacity-50',
            onEnd: function(evt) {
                const cardId = evt.item.dataset.cardId;
                const targetColumnId = evt.to.dataset.columnId;
                const position = evt.newIndex;

                htmx.ajax('PATCH', '/cards/' + cardId + '/move', {
                    target: '#board-columns',
                    swap: 'innerHTML',
                    values: {
                        target_column_id: targetColumnId,
                        position: position
                    }
                });
            }
        });
    });
}

// Auto-refresh board when CWA MCP broadcasts a task update
(function() {
    const wsUrl = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws';
    let ws, retryDelay = 1000;

    function connect() {
        ws = new WebSocket(wsUrl);

        ws.onmessage = function(event) {
            try {
                const msg = JSON.parse(event.data);
                const t = msg.type || msg.event;
                if (t === 'BoardRefresh' || t === 'board_refresh' || t === 'TaskUpdated') {
                    htmx.ajax('GET', '/boards/{{ board_id }}/columns', {
                        target: '#board-columns',
                        swap: 'innerHTML'
                    });
                }
            } catch (e) {}
        };

        ws.onopen = function() { retryDelay = 1000; };
        ws.onclose = function() {
            setTimeout(connect, Math.min(retryDelay *= 2, 30000));
        };
    }

    connect();
})();
</script>
{% endblock %}
